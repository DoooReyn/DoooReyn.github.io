<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A blog that records everything">
    <meta name="author" content="DoooReyn">
    <link rel="canonical" href="https://doooreyn.github.io/%E8%AF%AD%E8%A8%80/Lua/LUA_API%20lua_arith%20%282%29/">
    <link rel="shortcut icon" href="../../../img/favicon.ico">

    
    <title>Lua_API lua_arith (2) - DoooReynの星际航行日志</title>
    

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/v4-shims.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//rsms.me/inter/inter.css' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../../../css/base.min.css" rel="stylesheet">
    <link href="../../../css/cinder.min.css" rel="stylesheet">

    
        
        <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/styles/dracula.min.css">
        
    

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    

     
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            
              <a class="navbar-brand" href="../../..">DoooReynの星际航行日志</a>
            
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../../..">关于我</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">游戏城 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">游戏厅</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../%E6%B8%B8%E6%88%8F%E5%8E%85/%E5%A4%A7%E5%94%90%E7%9C%9F%E9%BE%99%E4%BC%A0/">大唐真龙传</a>
</li>

        
            
<li >
    <a href="../../../%E6%B8%B8%E6%88%8F%E5%8E%85/%E5%85%83%E6%B0%94%E5%81%B6%E5%83%8F%E5%AD%A3/">元气偶像季</a>
</li>

        
            
<li >
    <a href="../../../%E6%B8%B8%E6%88%8F%E5%8E%85/%E4%BC%A0%E5%A5%87%E7%B3%BB%E5%88%97/">传奇系列</a>
</li>

        
            
<li >
    <a href="../../../%E6%B8%B8%E6%88%8F%E5%8E%85/%E7%94%B5%E5%A8%B1%E5%A4%A7%E5%8E%85/">电娱大厅</a>
</li>

        
            
<li >
    <a href="../../../%E6%B8%B8%E6%88%8F%E5%8E%85/%E5%8D%B0%E5%B0%BC%E3%80%81%E6%B3%B0%E8%AF%AD%E6%A3%8B%E7%89%8C/">印尼/泰语棋牌</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">造轮子</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../%E9%80%A0%E8%BD%AE%E5%AD%90/%E7%9E%8E%E9%BC%93%E6%8D%A3%E6%BC%94%E7%A4%BA%E6%A1%88%E4%BE%8B/">瞎鼓捣演示案例</a>
</li>

        
            
<li >
    <a href="../../../%E9%80%A0%E8%BD%AE%E5%AD%90/%E6%89%8B%E5%8A%BF%E8%AF%86%E5%88%AB%E4%B8%8E%E8%AE%AD%E7%BB%83%E6%A8%A1%E5%9E%8B/">手势识别与训练模型</a>
</li>

        
            
<li >
    <a href="../../../%E9%80%A0%E8%BD%AE%E5%AD%90/PackManV2%E4%B8%80%E4%BD%93%E5%8C%96%E6%89%93%E5%8C%85%E5%B7%A5%E5%85%B7/">PackManV2一体化打包工具</a>
</li>

        
            
<li >
    <a href="../../../%E9%80%A0%E8%BD%AE%E5%AD%90/Cocos2d-x%20%E5%B5%8C%E5%85%A5%E6%9C%AC%E5%9C%B0%20HTTP%20Server/">Cocos2d-x 嵌入本地 HTTP Server</a>
</li>

        
            
<li >
    <a href="../../../%E9%80%A0%E8%BD%AE%E5%AD%90/Cocos2d-x%20%E5%B5%8C%E5%85%A5%E6%9C%AC%E5%9C%B0%20WebSocket%20Server/">Cocos2d-x 嵌入本地 WebSocket Server</a>
</li>

        
            
<li >
    <a href="../../../%E9%80%A0%E8%BD%AE%E5%AD%90/Cocos2d-x%20%E7%9B%AE%E5%BD%95%E7%9B%91%E8%A7%86%E5%99%A8/">Cocos2d-x 目录监视器</a>
</li>

        
            
<li >
    <a href="../../../%E9%80%A0%E8%BD%AE%E5%AD%90/Cocos2d-x%20FMOD%20%E9%9B%86%E6%88%90%E6%8C%87%E5%8D%97/">Cocos2d-x FMOD 集成指南</a>
</li>

        
            
<li >
    <a href="../../../%E9%80%A0%E8%BD%AE%E5%AD%90/Cocos2d-x%20%E4%BD%BF%E7%94%A8%20spdlog%20%E6%97%A5%E5%BF%97%E5%BA%93/">Cocos2d-x 使用 spdlog 日志库</a>
</li>

        
            
<li >
    <a href="../../../%E9%80%A0%E8%BD%AE%E5%AD%90/Cocos2d-x%20%E6%8E%A5%E5%85%A5%20lua-protobuf/">Cocos2d-x 接入 lua-protobuf</a>
</li>

        
            
<li >
    <a href="../../../%E9%80%A0%E8%BD%AE%E5%AD%90/Adjust%20%E7%AD%BE%E5%90%8D%E7%AC%AC%E4%BA%8C%E7%89%88%20Android%20%E9%9B%86%E6%88%90%E6%8C%87%E5%8D%97/">Adjust 签名第二版 Android 集成指南</a>
</li>

        
            
<li >
    <a href="../../../%E9%80%A0%E8%BD%AE%E5%AD%90/%E6%96%B0%E6%B4%BB%E5%8A%A8%E4%B8%AD%E5%BF%83%E6%BC%94%E7%A4%BA/">新活动中心演示</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">知识点</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../%E7%9F%A5%E8%AF%86%E7%82%B9/%E8%AE%B0%E4%B8%80%E6%AC%A1%20Cocos%20Creator%20Android%20%E6%89%93%E5%8C%85%E6%80%BB%E7%BB%93/">记一次 Cocos Creator Android 打包总结</a>
</li>

        
            
<li >
    <a href="../../../%E7%9F%A5%E8%AF%86%E7%82%B9/Cocos%20Creator%20Spine%20%C2%B7%20%E6%9B%B4%E6%8D%A2%E7%BA%B9%E7%90%86/">Cocos Creator Spine · 更换纹理</a>
</li>

        
            
<li >
    <a href="../../../%E7%9F%A5%E8%AF%86%E7%82%B9/Cocos%20Creator%20%E6%BB%A4%E9%95%9C%20%C2%B7%20%E9%A9%AC%E8%B5%9B%E5%85%8B/">Cocos Creator 滤镜 · 马赛克</a>
</li>

        
            
<li >
    <a href="../../../%E7%9F%A5%E8%AF%86%E7%82%B9/Cocos%20%E4%B8%AD%E7%9A%84%20Size/">Cocos 中的 Size</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">语言 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Lua</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../Lua%20%E6%95%B0%E7%BB%84%E5%AE%9E%E7%8E%B0/">Lua 数组实现</a>
</li>

        
            
<li >
    <a href="../Lua%20HashMap%20%E5%AE%9E%E7%8E%B0/">Lua HashMap 实现</a>
</li>

        
            
<li >
    <a href="../Lua%20%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8F%92%E5%80%BC%E5%AE%9E%E7%8E%B0/">Lua 字符串插值实现</a>
</li>

        
            
<li >
    <a href="../%E6%9B%B4%E7%AE%80%E6%B4%81%E7%9A%84%20lua%20%E9%80%BB%E8%BE%91%E4%BB%A3%E7%A0%81/">更简洁的 lua 逻辑代码</a>
</li>

        
            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Lua API 浅析</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../LUA_API%20Basic%20Types/">Lua_API Basic Types</a>
</li>

        
            
<li >
    <a href="../LUA_API%20lua_absindex/">Lua_API lua_absindex</a>
</li>

        
            
<li >
    <a href="../LUA_API%20lua_Alloc/">Lua_API lua_Alloc</a>
</li>

        
            
<li >
    <a href="../LUA_API%20lua_arith%20%281%29/">Lua_API lua_arith (1)</a>
</li>

        
            
<li class="active">
    <a href="./">Lua_API lua_arith (2)</a>
</li>

        
            
<li >
    <a href="../LUA_API%20lua_atpanic/">Lua_API lua_atpanic</a>
</li>

        
            
<li >
    <a href="../LUA_API%20lua_call%20%26%20lua_callk/">Lua_API lua_call & lua_callk</a>
</li>

        
    </ul>
  </li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">JavaScript</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../JavaScript/Faker.js%20%E5%88%86%E6%9E%90/">Faker.js 分析</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Python</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../Python/%E5%A6%82%E4%BD%95%E7%94%A8%20Python%20%E5%AE%9E%E7%8E%B0%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8F%92%E5%80%BC/">如何用 Python 实现字符串插值</a>
</li>

        
            
<li >
    <a href="../../Python/Pylint-%E4%BD%A0%E5%BE%88%E6%A3%92%EF%BC%8C%E4%BD%86%E6%88%91%E4%B8%8D%E6%83%B3%E8%B7%9F%E4%BD%A0%20PaPaPa/">Pylint-你很棒，但我不想跟你 PaPaPa</a>
</li>

        
            
<li >
    <a href="../../Python/Python%20%E7%88%AC%E5%8F%96%20gank.io%20%E4%BB%8A%E6%97%A5%E5%8A%9B%E6%8E%A8/">Python 爬取 gank.io 今日力推</a>
</li>

        
            
<li >
    <a href="../../Python/%E6%88%91%E6%9C%89%E5%B9%B2%E8%B4%A7%EF%BC%8C%E4%BD%A0%E6%95%A2%E6%94%B6%E5%90%97%EF%BC%9F/">我有干货，你敢收吗？</a>
</li>

        
            
<li >
    <a href="../../Python/RubyChina%20%E4%BC%98%E8%B4%A8%E5%B8%96%20Markdown%20%E6%A0%BC%E5%BC%8F%E6%95%B4%E7%90%86%EF%BC%88%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%EF%BC%89/">RubyChina 优质帖 Markdown 格式整理（第一部分）</a>
</li>

        
            
<li >
    <a href="../../Python/RubyChina%20%E4%BC%98%E8%B4%A8%E5%B8%96%20Markdown%20%E6%A0%BC%E5%BC%8F%E6%95%B4%E7%90%86%EF%BC%88%E7%AC%AC%E4%B8%89%E9%83%A8%E5%88%86%EF%BC%89/">RubyChina 优质帖 Markdown 格式整理（第三部分）</a>
</li>

        
            
<li >
    <a href="../../Python/RubyChina%20%E4%BC%98%E8%B4%A8%E5%B8%96%20Markdown%20%E6%A0%BC%E5%BC%8F%E6%95%B4%E7%90%86%EF%BC%88%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%EF%BC%89/">RubyChina 优质帖 Markdown 格式整理（第二部分）</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">PHP</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../PHP/Windows%20%E5%AE%89%E8%A3%85%20PHP7.4/">Windows 安装 PHP7.4</a>
</li>

        
            
<li >
    <a href="../../PHP/CentOS%20%E5%AE%89%E8%A3%85%20PHP7.4/">CentOS 安装 PHP7.4</a>
</li>

        
            
<li >
    <a href="../../PHP/%E6%9F%A5%E7%9C%8B%20php.ini%20%E5%AD%98%E6%94%BE%E5%9C%B0%E5%9D%80/">查看 php.ini 存放地址</a>
</li>

        
            
<li >
    <a href="../../PHP/%E5%AE%89%E8%A3%85%20Composer/">安装 Composer</a>
</li>

        
            
<li >
    <a href="../../PHP/%E5%AE%89%E8%A3%85%20MixPhp/">安装 MixPhp</a>
</li>

        
            
<li >
    <a href="../../PHP/%E5%AE%89%E8%A3%85%20Swoole/">安装 Swoole</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">工具箱 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../../%E5%B7%A5%E5%85%B7%E7%AE%B1/%E5%BE%AE%E8%AF%BB%E8%87%AA%E5%8A%A8%E9%98%85%E8%AF%BB%E5%99%A8/">微读自动阅读器</a>
</li>

                        
                            
<li >
    <a href="../../../%E5%B7%A5%E5%85%B7%E7%AE%B1/%E5%B7%A5%E8%B5%84%E6%98%8E%E7%BB%86%E5%8A%A9%E6%89%8B/">工资明细助手</a>
</li>

                        
                            
<li >
    <a href="../../../%E5%B7%A5%E5%85%B7%E7%AE%B1/BMFont%20Toolbox%20%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/">BMFont Toolbox 使用指南</a>
</li>

                        
                            
<li >
    <a href="../../../%E5%B7%A5%E5%85%B7%E7%AE%B1/%E6%9F%A5%E7%9C%8B%E6%96%87%E4%BB%B6%20md5%20sha1%20sha256%20%E5%80%BC/">查看文件 md5 sha1 sha256 值</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">医药箱 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Android</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Android/ADB%20%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4/">ADB 常用指令</a>
</li>

        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Android/ADB%20%E8%B0%83%E8%AF%95%E8%BF%9E%E6%8E%A5%E5%A4%9C%E7%A5%9E%E6%A8%A1%E6%8B%9F%E5%99%A8/">ADB 调试连接夜神模拟器</a>
</li>

        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Android/Android%20NDK%20%E5%8E%86%E5%8F%B2%E7%89%88%E6%9C%AC/">Android NDK 历史版本</a>
</li>

        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Android/Android%20SDK%20%E7%89%88%E6%9C%AC%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB/">Android SDK 版本之间的关系</a>
</li>

        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Android/Android%20Studio%20%E5%8D%A0%E7%94%A8%E6%9E%81%E5%A4%A7%E5%86%85%E5%AD%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/">Android Studio 占用极大内存的解决方法</a>
</li>

        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Android/Android%20Studio%20Clean%20%E4%B8%8E%20Rebuild%20%E7%9A%84%E5%8C%BA%E5%88%AB/">Android Studio Clean 与 Rebuild 的区别</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Mac</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Mac/AppleScript%20%E6%90%AD%E9%85%8D%20Alfred%20%E7%9C%9F%E4%B9%83%E5%88%A9%E5%99%A8/">AppleScript 搭配 Alfred 真乃利器</a>
</li>

        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Mac/Mac%20%E9%9F%B3%E9%87%8F%E5%BE%AE%E8%B0%83/">Mac 音量微调</a>
</li>

        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Mac/Mac%20%E5%BA%94%E7%94%A8%E5%B7%B2%E6%8D%9F%E5%9D%8F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">Mac 应用已损坏解决方案</a>
</li>

        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Mac/Mac%20nvm%20%E5%AE%8C%E5%85%A8%E5%8D%B8%E8%BD%BD%E6%8C%87%E5%8D%97/">Mac nvm 完全卸载指南</a>
</li>

        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Mac/Mac%20zsh%20%E7%B2%98%E8%B4%B4%E5%8A%A0%E9%80%9F/">Mac zsh 粘贴加速</a>
</li>

        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Mac/MacOS%20%E5%AE%89%E8%A3%85%20autojump/">MacOS 安装 autojump</a>
</li>

        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Mac/MacOS%20%E5%AE%89%E8%A3%85%20Pillow/">MacOS 安装 Pillow</a>
</li>

        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Mac/MacOS%20%E5%8D%B8%E8%BD%BD%20Java9/">MacOS 卸载 Java9</a>
</li>

        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Mac/MacOS%20Java%20%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86/">MacOS Java 版本管理</a>
</li>

        
            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Xcode error</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Mac/your%20session%20has%20expired%2C%20please%20log%20in/">your session has expired, please log in</a>
</li>

        
    </ul>
  </li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Git</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Git/Git%20%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%90%86/">Git 设置代理</a>
</li>

        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Git/%E8%A7%A3%E5%86%B3%20Github%20%E8%B4%A1%E7%8C%AE%E5%80%BC%E4%B8%8D%E8%AE%A1%E7%AE%97%E9%97%AE%E9%A2%98/">解决 Github 贡献值不计算问题</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">Interview</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Interview/HR%20%E9%9D%A2/">HR 面</a>
</li>

        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Interview/%E6%8A%80%E6%9C%AF%E9%9D%A2/">技术面</a>
</li>

        
            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/Interview/%E4%B8%AA%E4%BA%BA%E6%80%BB%E7%BB%93/">个人总结</a>
</li>

        
    </ul>
  </li>

                        
                            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/%E6%9F%A5%E7%9C%8B%20npm%20%E5%AE%89%E8%A3%85%E4%BD%8D%E7%BD%AE/">查看 npm 安装位置</a>
</li>

                        
                            
<li >
    <a href="../../../%E5%8C%BB%E8%8D%AF%E7%AE%B1/%E8%A7%A3%E5%86%B3%20Windows%20%E9%95%BF%E8%B7%AF%E5%BE%84%E9%97%AE%E9%A2%98/">解决 Windows 长路径问题</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">图书馆 <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">算法</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E7%AE%97%E6%B3%95/%E7%AE%97%E6%B3%95%E7%9A%84%E6%97%B6%E9%97%B4%E4%B8%8E%E7%A9%BA%E9%97%B4%E5%A4%8D%E6%9D%82%E5%BA%A6/">算法的时间与空间复杂度</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E7%AE%97%E6%B3%95/%E6%9F%A5%E6%89%BE%E7%AE%97%E6%B3%95%E6%80%BB%E7%BB%93%E5%8F%8A%E5%85%B6%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/">查找算法直接及其算法实现</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E7%AE%97%E6%B3%95/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%E6%80%A7%E8%83%BD%E5%8F%8A%E9%80%89%E6%8B%A9%E6%80%BB%E7%BB%93/">排序算法性能及选择总结</a>
</li>

        
    </ul>
  </li>

                        
                            
  <li class="dropdown-submenu">
    <a tabindex="-1" href="">书籍</a>
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/Github%E4%B8%8A%E7%9A%84%E7%94%B5%E5%AD%90%E4%B9%A6/">Github上的电子书</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E8%BF%91%E4%B8%87%E6%9C%AC%E6%8A%80%E6%9C%AF%E7%94%B5%E5%AD%90%E4%B9%A6%E5%85%8D%E8%B4%B9%E4%B8%8B%E8%BD%BD/">近万本技术电子书免费下载</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91%E7%94%B5%E5%AD%90%E4%B9%A6%E4%B8%8B%E8%BD%BD/">游戏开发电子书下载</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/J%C2%B7%E5%B8%83%E7%BD%97%E5%85%8B%E6%9B%BC-%E6%9C%AA%E6%9D%A5%E4%BA%94%E5%8D%81%E5%B9%B4/">J·布罗克曼-未来五十年</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E5%8C%97%E5%B2%9B%E3%80%8A%E6%B3%A2%E5%85%B0%E6%9D%A5%E5%AE%A2%E3%80%8B/">北岛《波兰来客》</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E9%99%88%E5%B9%B3%E3%80%8A%E4%BB%A3%E8%B0%A2%E5%A2%9E%E9%95%BF%E8%AE%BA%E3%80%8B/">陈平《代谢增长论》</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E9%99%88%E5%B9%B3-%E8%87%AA%E7%94%B1%E7%9A%84%E5%AF%B9%E7%AB%8B%E9%9D%A2%E4%B8%8D%E6%98%AF%E4%B8%93%E6%94%BF%E6%98%AF%E8%87%AA%E5%BE%8B/">陈平-自由的对立面不是专政是自律</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E7%A7%91%E6%AF%94%C2%B7%E5%B8%83%E8%8E%B1%E6%81%A9%E7%89%B9%20%E3%80%8A%E6%9B%BC%E5%B7%B4%E7%B2%BE%E7%A5%9E%EF%BC%9A%E7%A7%91%E6%AF%94%E8%87%AA%E4%BC%A0%E3%80%8B/">科比·布莱恩特 《曼巴精神:科比自传》</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E8%82%AF%C2%B7%E7%BD%97%E5%AE%BE%E9%80%8A%20%E5%8D%A2%C2%B7%E9%98%BF%E7%BD%97%E5%B0%BC%E5%8D%A1-%E4%BB%80%E4%B9%88%E6%98%AF%E6%9C%80%E5%A5%BD%E7%9A%84%E6%95%99%E8%82%B2/">肯·罗宾逊 卢·阿罗尼卡-什么是最好的教育</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E5%8A%B3%E4%BC%A6%E6%96%AF%C2%B7%E5%B8%83%E6%B4%9B%E5%85%8B-%E5%B0%8F%E8%AF%B4%E7%9A%84%E5%85%AB%E7%99%BE%E4%B8%87%E7%A7%8D%E5%86%99%E6%B3%95/">劳伦斯·布洛克-小说的八百万种写法</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E6%9D%8E%E6%95%96-%E5%8C%97%E4%BA%AC%E6%B3%95%E6%BA%90%E5%AF%BA/">李敖-北京法源寺</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E6%9D%8E%E6%B7%BC%C2%B7%E3%80%8A%E4%B8%89%E4%BD%93%E3%80%8B%E4%B8%AD%E7%9A%84%E7%89%A9%E7%90%86%E5%AD%A6/">李淼·《三体》中的物理学</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E7%BD%97%E4%BC%AF%E7%89%B9%C2%B7L.%E5%87%AF%E5%88%A9-%E7%AC%AC%E4%BA%94%E6%AC%A1%E5%BC%80%E5%A7%8B/">罗伯特·L.凯利-第五次开始</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E5%90%95%E6%80%9D%E5%8B%89%E3%80%8A%E4%B8%AD%E5%9B%BD%E9%80%9A%E5%8F%B2%E3%80%8B%E7%BB%AA%E8%AE%BA/">吕思勉《中国通史》</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E6%98%8E%E9%81%93-%E5%9B%BE%E8%A7%A3%E9%80%BB%E8%BE%91%E5%AD%A6/">明道-图解逻辑学</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E9%9D%92%E5%B1%B1%E4%B8%83%E6%83%A0%E3%80%8A%20%E4%B8%80%E4%B8%AA%E4%BA%BA%E7%9A%84%E5%A5%BD%E5%A4%A9%E6%B0%94%E3%80%8B/">青山七惠·《一个人的好天气》</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E6%B8%85%E6%B0%B4%E8%8D%A3%E5%8F%B8%E3%80%8A%E8%AE%A4%E7%94%9F%E7%9A%84%E4%BA%BA%EF%BC%9A%E5%A6%82%E4%BD%95%E5%85%8B%E6%9C%8D%E7%A4%BE%E4%BA%A4%E7%84%A6%E8%99%91%E3%80%8B/">清水荣司《认生的人:如何克服社交焦虑》</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E7%91%9E%C2%B7%E8%BE%BE%E5%88%A9%E6%AC%A7%20%E3%80%8A%E5%8E%9F%E5%88%99%E3%80%8B/">瑞·达利欧 《原则》</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E5%8D%AB%E5%AE%AB%E5%A3%AB%E9%83%8E%20%E3%80%8AFateStay%20Night%20Unlimited%20Blade%20Works%E3%80%8B/">卫宫士郎 《FateStay Night Unlimited Blade Works》</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E6%B8%A9%E9%93%81%E5%86%9B%20%E3%80%8A%E4%B9%A1%E5%BB%BA%E7%AC%94%E8%AE%B0%EF%BC%9A%E6%96%B0%E9%9D%92%E5%B9%B4%E4%B8%8E%E4%B9%A1%E6%9D%91%E7%9A%84%E7%94%9F%E5%91%BD%E5%AF%B9%E8%AF%9D%E3%80%8B/">温铁军 《乡建笔记:新青年与乡村的生命对话》</a>
</li>

        
            
<li >
    <a href="../../../%E5%9B%BE%E4%B9%A6%E9%A6%86/%E5%B0%A4%E7%93%A6%E5%B0%94%C2%B7%E8%B5%AB%E6%8B%89%E5%88%A9%E3%80%8A%E6%9C%AA%E6%9D%A5%E7%AE%80%E5%8F%B2%EF%BC%9A%E4%BB%8E%E6%99%BA%E4%BA%BA%E5%88%B0%E6%99%BA%E7%A5%9E%E3%80%8B/">尤瓦尔·赫拉利《未来简史:从智人到智神》</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
                    <li >
                        <a rel="prev" href="../LUA_API%20lua_arith%20%281%29/">
                            <i class="fas fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="next" href="../LUA_API%20lua_atpanic/">
                            Next <i class="fas fa-arrow-right"></i>
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#lua_api_lua_arith_2">LUA_API lua_arith (2)</a></li>
            <li class="second-level"><a href="#_1">开篇</a></li>
                
            <li class="second-level"><a href="#_2">解析</a></li>
                
                <li class="third-level"><a href="#tvalue">TValue</a></li>
            <li class="second-level"><a href="#operator_rules">Operator Rules</a></li>
                
                <li class="third-level"><a href="#1_lua_integer">1. lua_Integer</a></li>
                <li class="third-level"><a href="#2_tointeger">2. tointeger</a></li>
                <li class="third-level"><a href="#3_intarith">3. intarith</a></li>
                <li class="third-level"><a href="#4_setivalue">4. setivalue</a></li>
                <li class="third-level"><a href="#luat_trybintm">luaT_trybinTM</a></li>
                <li class="third-level"><a href="#_3">回到最初</a></li>
                <li class="third-level"><a href="#_4">小结</a></li>
            <li class="second-level"><a href="#_5">终了</a></li>
                
            <li class="second-level"><a href="#_6">参考</a></li>
                
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<div><h2 id="lua_api_lua_arith_2">LUA_API lua_arith (2)<a class="headerlink" href="#lua_api_lua_arith_2" title="Permanent link">¶</a></h2>
<h3 id="_1">开篇<a class="headerlink" href="#_1" title="Permanent link">¶</a></h3>
<blockquote>
<p>上一节分析了 <code>lua_arith</code> 的大部分代码，由于篇幅原因，留到本节将继续讲解剩余的部分：</p>
</blockquote>
<pre class="codehilite"><code class="language-c linenums">luaO_arith(L, op, L-&gt;top - 2, L-&gt;top - 1, L-&gt;top - 2);
L-&gt;top--;  /* remove second operand */
lua_unlock(L);
</code></pre>

<h3 id="_2">解析<a class="headerlink" href="#_2" title="Permanent link">¶</a></h3>
<p>现在我们来看运算规则 <code>luaO_arith</code> ：</p>
<pre class="codehilite"><code class="language-c linenums">// lobject.c 123
void luaO_arith (lua_State *L, int op, const TValue *p1, const TValue *p2,
                 TValue *res) {
  switch (op) {
    case LUA_OPBAND: case LUA_OPBOR: case LUA_OPBXOR:
    case LUA_OPSHL: case LUA_OPSHR:
    case LUA_OPBNOT: {  /* operate only on integers */
      lua_Integer i1; lua_Integer i2;
      if (tointeger(p1, &amp;i1) &amp;&amp; tointeger(p2, &amp;i2)) {
        setivalue(res, intarith(L, op, i1, i2));
        return;
      }
      else break;  /* go to the end */
    }
    case LUA_OPDIV: case LUA_OPPOW: {  /* operate only on floats */
      lua_Number n1; lua_Number n2;
      if (tonumber(p1, &amp;n1) &amp;&amp; tonumber(p2, &amp;n2)) {
        setfltvalue(res, numarith(L, op, n1, n2));
        return;
      }
      else break;  /* go to the end */
    }
    default: {  /* other operations */
      lua_Number n1; lua_Number n2;
      if (ttisinteger(p1) &amp;&amp; ttisinteger(p2)) {
        setivalue(res, intarith(L, op, ivalue(p1), ivalue(p2)));
        return;
      }
      else if (tonumber(p1, &amp;n1) &amp;&amp; tonumber(p2, &amp;n2)) {
        setfltvalue(res, numarith(L, op, n1, n2));
        return;
      }
      else break;  /* go to the end */
    }
  }
  /* could not perform raw operation; try metamethod */
  lua_assert(L != NULL);  /* should not fail when folding (compile time) */
  luaT_trybinTM(L, p1, p2, res, cast(TMS, (op - LUA_OPADD) + TM_ADD));
}
</code></pre>

<h4 id="tvalue">TValue<a class="headerlink" href="#tvalue" title="Permanent link">¶</a></h4>
<p>注意到参数 <code>3, 4</code> 是两个操作数，且它们都是 <code>TValue *</code> 类型，我们找到 <code>TValue</code> 的定义：</p>
<pre class="codehilite"><code class="linenums">// lobject.h 100
/*
** Union of all Lua values
*/
typedef union Value {
  GCObject *gc;    /* collectable objects : 可回收的对象 */
  void *p;         /* light userdata : 轻量级 userdata */
  int b;           /* booleans : 布尔值*/
  lua_CFunction f; /* light C functions : 轻量级 C 函数 */
  lua_Integer i;   /* integer numbers : 整型数 */
  lua_Number n;    /* float numbers : 浮点数 */
} Value;


#define TValuefields  Value value_; int tt_


typedef struct lua_TValue {
  TValuefields;
} TValue;
</code></pre>

<p><code>TValue</code> 是一个结构体别名，用它可以定义一个结构体，其中包含一个联合体 <code>value_</code> 和一个整型数 <code>tt_</code>；而 <code>value_</code> 包含了所有 <code>Lua</code> 的值类型：<code>可回收的对象</code>、<code>轻量级 userdata</code>、<code>布尔值</code>、<code>轻量级 C 函数</code>、<code>整型数</code> 和 <code>浮点数</code>。也就是说，除了 <code>GCObject</code>，其他 5 个数据类型是不用 <code>Lua</code> 回收机制的。</p>
<p>我们来看 <code>GCObject</code>：</p>
<pre class="codehilite"><code class="language-c linenums">// lobject.h 72
/*
** Common type for all collectable objects
*/
typedef struct GCObject GCObject;


/*
** Common Header for all collectable objects (in macro form, to be
** included in other objects)
*/
#define CommonHeader  GCObject *next; lu_byte tt; lu_byte marked


/*
** Common type has only the common header
*/
struct GCObject {
  CommonHeader;
};
</code></pre>

<p>知道 <code>GCObject</code> 首先是个结构体，其次它包含了三个域 ：<code>GCObject *next; lu_byte tt; lu_byte marked</code>；这里 <code>GCObject *</code> 又被替换为结构体类型 <code>struct GCObject *</code>。再看 <code>lu_byte</code> ：</p>
<pre class="codehilite"><code class="language-c linenums">// llimits.h 35
/* chars used as small naturals (so that 'char' is reserved for characters) */
typedef unsigned char lu_byte;
</code></pre>

<p>可知，<code>lu_byte</code> 就是简单的类型别名，用一个 <code>unsigned char</code> 类型来表示。
综上对 <code>GCObject</code> 的分析，可得：所有的 <code>GCObject</code> 都用一个<strong>单向链表</strong>串了起来，每个 <code>GCObject</code> 对象都携带 <code>tt, marked</code> 两个标记<em>（其中 <code>tt</code> 用来识别其类型，<code>marked</code> 域用于标记清除的工作，这些是后话了，现在我也不懂）</em>。</p>
<p>现在是不是可以理解 Lua 官方对值和类型的说明了：</p>
<blockquote>
<p>Lua is a dynamically typed language. This means that variables do not have types; only values do. There are no type definitions in the language. All values carry their own type.</p>
</blockquote>
<p>因为 <code>TValue</code> 携带了所有的 <code>Lua</code> 值类型，这就是变量没有类型，只有值才有类型的原因！</p>
<h3 id="operator_rules">Operator Rules<a class="headerlink" href="#operator_rules" title="Permanent link">¶</a></h3>
<p>解释完 <code>TValue</code>，我们来归纳一下 <code>switch</code> 之后的运算符规则：</p>
<ul>
<li><code>LUA_OPBAND、 LUA_OPBOR、 LUA_OPBXOR、 LUA_OPSHL、 LUA_OPSHR、 LUA_OPBNOT</code> 遵循 <code>[1]</code> 操作；</li>
<li><code>LUA_OPDIV、 LUA_OPPOW</code> 遵循 <code>[2]</code> 操作；</li>
<li><code>LUA_OPADD、 LUA_OPSUB、 LUA_OPMUL、 LUA_OPMOD、 LUA_OPUNM</code> 遵循 <code>default</code> <code>[3]</code> 操作。</li>
</ul>
<p>下面以 <code>[1]</code> 作为切入口来解析具体的运算服规则，由于其他操作活类似或略有不同，因此不再多费唇舌。
注意到 <code>[1]</code> 中的元素都是单目运算符，其运算规则为：</p>
<pre class="codehilite"><code class="language-c linenums">{
    lua_Integer i1; lua_Integer i2;
    if (tointeger(p1, &amp;i1) &amp;&amp; tointeger(p2, &amp;i2)) {
      setivalue(res, intarith(L, op, i1, i2));
      return;
    }
    else break;  /* go to the end */
}
</code></pre>

<p>按步骤来说：</p>
<ol>
<li>声明两个 <code>lua_Integer</code> 类型数据 <code>i1, i2</code>；</li>
<li>将两个操作数进行类型转换，并将结果分别存储到 <code>i1, i2</code>；</li>
<li>如果转换成功，则执行运算后直接返回。</li>
<li>如果转换失败，则跳出 <code>switch</code>。</li>
</ol>
<p>接下来我们逐个分析几个要点：</p>
<ol>
<li><code>lua_Integer</code></li>
<li><code>tointeger</code></li>
<li><code>ntarith</code></li>
<li><code>setivalue</code></li>
</ol>
<h4 id="1_lua_integer">1. lua_Integer<a class="headerlink" href="#1_lua_integer" title="Permanent link">¶</a></h4>
<p><code>lua_Integer</code> 定义在 <code>lua.h 93</code> 行：<code>typedef LUA_INTEGER lua_Integer;</code>。这里是为 <code>LUA_INTEGER</code> 定义了别名 <code>lua_Integer</code>。而 <code>LUA_INTEGER</code> 在 <code>luaconf.h 524 ~ 574</code> 行之间有详细的说明，它指代的是整型数据类型。</p>
<h4 id="2_tointeger">2. tointeger<a class="headerlink" href="#2_tointeger" title="Permanent link">¶</a></h4>
<p><code>tointeger</code> 定义在 <code>lvm.h 43</code> 行：  </p>
<pre class="codehilite"><code class="language-c linenums">#define tointeger(o,i) \
    (ttisinteger(o) ? (*(i) = ivalue(o), 1) : luaV_tointeger(o,i,LUA_FLOORN2I))
</code></pre>

<p>再看 <code>ttisinteger</code> 和 <code>ivalue</code> 是这么定义的：</p>
<pre class="codehilite"><code class="language-c linenums">/* raw type tag of a TValue */
#define rttype(o) ((o)-&gt;tt_)

#define checktag(o,t)   (rttype(o) == (t))
#define ttisinteger(o)    checktag((o), LUA_TNUMINT)

#define check_exp(c,e)    (lua_assert(c), (e))
#define val_(o)   ((o)-&gt;value_)
#define ivalue(o) check_exp(ttisinteger(o), val_(o).i)
</code></pre>

<p>现在我们知道 <code>o</code> 是 <code>Lua</code> 原始值 <code>TValue *o</code>, <code>rttype(o)</code> 获取的是原始值的 <code>tt_</code> 标记，而 <code>tt_</code> 则是原始值类型标记，因此通过 <code>checktag(o,t)</code> 可以检查原始值类型标记 <code>tt_</code> 是否与预期 <code>t</code> 符合，已达到检查值类型的目的。</p>
<p>接着看 <code>ivalue(o)</code>：首先它通过 <code>ttisinteger(o)</code> 检查当前原始值的类型标记 <code>tt_</code> 是不是整型作为断言的判断条件，其次通过 <code>val_(o)</code> 取出原始值的真实值 <code>value_</code> 中的整型域作为断言的消息，最后通过 <code>check_exp(c,e)</code> 进行断言操作。</p>
<p>我们回过头看 <code>ttisinteger</code>，就可以拆成 <code>tt + isinteger</code>，意思是原始值的标记 <code>tt_</code> 标记的是不是整型类型。那么 <code>LUA_TNUMINT</code> 指代的就是 <code>Lua</code> 中的整型类型了。来看看是不是这样：</p>
<pre class="codehilite"><code class="language-c linenums">#define LUA_TNUMBER   3

/* Variant tags for numbers */
#define LUA_TNUMFLT (LUA_TNUMBER | (0 &lt;&lt; 4))  /* float numbers */
#define LUA_TNUMINT (LUA_TNUMBER | (1 &lt;&lt; 4))  /* integer numbers */
</code></pre>

<p>一看不得了，我们顺便知道了 <code>LUA_TNUMBER</code> 定义了 <code>LUA_TNUMFLT</code> 和 <code>LUA_TNUMINT</code>，也就是 <code>number</code> 类型包含了整型和浮点型，这也跟官方的介绍不谋而合：</p>
<blockquote>
<p>The type number represents both integer numbers and real (floating-point) numbers. </p>
</blockquote>
<p>然而，有点经验的同学可能有疑问了：在 <code>Lua 5.2</code> 版本中，所有的 <code>number</code> 不都是浮点数吗？那这又是什么鬼？
一个可能是我们理解错了，一个可能就是在 <code>Lua 5.3</code> 版本中对其做出了修改。我们看版本变更日志是否有提及此事：</p>
<blockquote>
<p>8.1 – Changes in the Language   </p>
<ul>
<li>
<p>The main difference between Lua 5.2 and Lua 5.3 is the introduction of an integer subtype for numbers. Although this change should not affect "normal" computations, some computations (mainly those that involve some kind of overflow) can give different results.<br>
You can fix these differences by forcing a number to be a float (in Lua 5.2 all numbers were float), in particular writing constants with an ending .0 or using x = x + 0.0 to convert a variable. (This recommendation is only for a quick fix for an occasional incompatibility; it is not a general guideline for good programming. For good programming, use floats where you need floats and integers where you need integers.)  </p>
</li>
<li>
<p>The conversion of a float to a string now adds a .0 suffix to the result if it looks like an integer. (For instance, the float 2.0 will be printed as 2.0, not as 2.) You should always use an explicit format when you need a specific format for numbers.</p>
</li>
</ul>
<p>简单翻译： </p>
<ul>
<li>Lua 5.3 与 Lua 5.2 版本主要的差别就是 numbers 新增了子类型 integer。尽管这个改动并不影响“普通”的计算，但部分计算（主要是一些涉及溢出的计算）可能会与之前的版本的计算结果有所不同。<br>
一个修正的方案是将 number 强转为 float (在 Lua 5.2 中所有的 numbers 都是 float)。你可以在常熟后加上 .0 或者使用 x = x + 0.0 的方法来转换。（但这些建议是为了兼容而作的妥协，而并非良好的编程纲领，好的方式是：当用 float 则用 float，当用 integer 则用 integer，泾渭分明，分而治之。）</li>
<li>当将 float 转换为 string 时，如果结果看上去像是 integer，会在结果最后加上 .0。（举个例子，浮点型 2.0 打印出来是 2.0，而不是 2。）</li>
</ul>
</blockquote>
<p>果不其然，我们的分析是正确的，大家可以用两个版本分别验证一下：</p>
<pre class="codehilite"><code class="language-bash linenums">Lua 5.2.4
&gt; a = 1 + 3.0
&gt; print(a)
4
---------------
Lua 5.3.3
&gt; a = 1 + 3.0
&gt; print(a)
4.0
</code></pre>

<p>另提一点， 5.3 版本的解释器已经支持直接计算了：</p>
<pre class="codehilite"><code class="language-bash linenums">Lua 5.2.4
&gt; 1 + 3.0
stdin:1: unexpected symbol near '1'

Lua 5.3.3
&gt; 1 + 3.0
4.0
</code></pre>

<p>现在剩下一个 <code>luaV_tointeger</code> 还在浆糊之中，我们再行探究：</p>
<pre class="codehilite"><code class="language-c linenums">// lvm.c 94
/*
** try to convert a value to an integer, rounding according to 'mode':
** mode == 0: accepts only integral values
** mode == 1: takes the floor of the number
** mode == 2: takes the ceil of the number
*/
// 注意：integral 是完整的、整体的意思，而非整数！
int luaV_tointeger (const TValue *obj, lua_Integer *p, int mode) {
  TValue v;
 again:
  if (ttisfloat(obj)) {
    lua_Number n = fltvalue(obj); // 取原始值 value_ 的 n 域
    lua_Number f = l_floor(n);    // 对 n 进行 floor 操作，赋值给 f
    // 如果 n != f，那么 obj 就是不可转换为类整数的浮点数 （如2.01）
    if (n != f) {  /* not an integral value? */
      // 而如果 mode ＝ 0，即要求操作数可转换为类整数，那么就直接返回 0
      if (mode == 0) return 0;  /* fails if mode demands integral value */
      // 如果 mode &gt; 1，即要求将操作数进行向上取整
      else if (mode &gt; 1)  /* needs ceil? */
        f += 1;  /* convert floor to ceil (remember: n != f) */
    }
    // 然后执行 number 转换为 integer 操作
    return lua_numbertointeger(f, p);
  }
  else if (ttisinteger(obj)) {
    // 如果操作数本身就是整型数据，那么直接讲原始值的 value_ 的 整数域赋值给 *p 即可
    *p = ivalue(obj);
    return 1;
  }
  else if (cvt2num(obj) &amp;&amp;
            luaO_str2num(svalue(obj), &amp;v) == vslen(obj) + 1) {
    // 如果操作数是字符串，且可完全转换为 number，则将操作数替换为转换后的值后，重头开始转换
    obj = &amp;v;
    goto again;  /* convert result from 'luaO_str2num' to an integer */
  }
  // 转换失败
  return 0;  /* conversion failed */
}

/********* 补充定义 **********/

// fltvalue 
#define fltvalue(o) check_exp(ttisfloat(o), val_(o).n)

// l_floor 
#define l_floor(x)    (l_mathop(floor)(x))

// lua_numbertointeger 
#define lua_numbertointeger(n,p) \
  ((n) &gt;= (LUA_NUMBER)(LUA_MININTEGER) &amp;&amp; \
   (n) &lt; -(LUA_NUMBER)(LUA_MININTEGER) &amp;&amp; \
      (*(p) = (LUA_INTEGER)(n), 1))

// svalue 
// 从原始值中获取实际的字符串（字节数组）
/* get the actual string (array of bytes) from a Lua value */
#define svalue(o)       getstr(tsvalue(o))

// LUA_FLOORN2I 
// 默认 LUA_FLOORN2I ＝ 0
/*
** You can define LUA_FLOORN2I if you want to convert floats to integers
** by flooring them (instead of raising an error if they are not
** integral values)
*/
#if !defined(LUA_FLOORN2I)
#define LUA_FLOORN2I    0
#endif
</code></pre>

<p>现在，我们重新理解 <code>luaV_tointeger(o,i,LUA_FLOORN2I)</code> 就很简单了，就是将原始值 <code>o</code>
 转换为整型数据，然后赋值给 <code>i</code>，当然如果转换成功则返回 <code>1</code>，失败则返回 <code>0</code>。
回过头再看 tointeger 的定义：</p>
<pre class="codehilite"><code class="language-c linenums">#define tointeger(o,i) \
    (ttisinteger(o) ? (*(i) = ivalue(o), 1) : luaV_tointeger(o,i,LUA_FLOORN2I))
</code></pre>

<p>现在可以轻松地解释清楚了：如果原始值 <code>o</code> 的当前类型标记是整型，则取它的整型数据部分，并返回 <code>1</code>；否则，尝试进行转换，转换成功则取转换结果并返回 <code>1</code>，失败则返回 <code>0</code>；其中 <code>1</code> 代表成功，<code>0</code> 代表失败。完美！</p>
<h4 id="3_intarith">3. intarith<a class="headerlink" href="#3_intarith" title="Permanent link">¶</a></h4>
<p><code>intarith</code> 可以拆解为 <code>int(eger)</code> 和 <code>arith(metic)</code>，顾名思义：整数运算的意思。我们来看定义：</p>
<pre class="codehilite"><code class="language-c linenums">static lua_Integer intarith (lua_State *L, int op, lua_Integer v1,
                                                   lua_Integer v2) {
  switch (op) {
    case LUA_OPADD: return intop(+, v1, v2);
    case LUA_OPSUB:return intop(-, v1, v2);
    case LUA_OPMUL:return intop(*, v1, v2);
    case LUA_OPMOD: return luaV_mod(L, v1, v2);
    case LUA_OPIDIV: return luaV_div(L, v1, v2);
    case LUA_OPBAND: return intop(&amp;, v1, v2);
    case LUA_OPBOR: return intop(|, v1, v2);
    case LUA_OPBXOR: return intop(^, v1, v2);
    case LUA_OPSHL: return luaV_shiftl(v1, v2);
    case LUA_OPSHR: return luaV_shiftl(v1, -v2);
    case LUA_OPUNM: return intop(-, 0, v1);
    case LUA_OPBNOT: return intop(^, ~l_castS2U(0), v1);
    default: lua_assert(0); return 0;
  }
}

/********** 补充定义 **********/

#define intop(op,v1,v2) l_castU2S(l_castS2U(v1) op l_castS2U(v2))

#if !defined(l_castU2S)
#define l_castU2S(i)  ((lua_Integer)(i))
#endif

#if !defined(l_castS2U)
#define l_castS2U(i)  ((lua_Unsigned)(i))
#endif

/* unsigned integer type */
typedef LUA_UNSIGNED lua_Unsigned;

#define LUA_UNSIGNED    unsigned LUAI_UACINT

#define LUAI_UACINT   LUA_INTEGER
</code></pre>

<p><code>intop(op, v1, v2)</code>，先将 <code>v1, v2</code> 转换为无符号整型，计算出结果之后，再将结果转换为有符号整型。
<code>luaV_mod</code>、<code>luaV_div</code>、<code>luaV_shiftl</code> 则对应 <code>取模、除法、左移</code> 操作，这里就不展开了，读者自行探究。</p>
<h4 id="4_setivalue">4. setivalue<a class="headerlink" href="#4_setivalue" title="Permanent link">¶</a></h4>
<p>现在来看最后一个要点：<code>setivalue(v1, v2)</code>。
我们知道 <code>ivalue</code> 是取原始值的整型部分数值，那么不妨把 <code>setivalue</code> 拆解为 <code>set</code> 和 <code>ivalue</code>，解释为将 <code>v2</code> 赋值给 <code>v1</code> 的整型部分。来看看是不是这样？</p>
<pre class="codehilite"><code class="language-c linenums">#define setivalue(obj,x) \
  { TValue *io=(obj); val_(io).i=(x); settt_(io, LUA_TNUMINT); }

#define settt_(o,t) ((o)-&gt;tt_=(t))
</code></pre>

<p>我们看到 <code>setivalue</code> 和 <code>settt_</code> 是宏定义，我们用 <code>v1, v2</code> 带入后展开：</p>
<pre class="codehilite"><code class="language-c linenums">{ TValue *io=(v1); val_(io).i=(v2); io-&gt;tt_=(LUA_TNUMINT); }
</code></pre>

<p>果然，除了最后将原始值的类型标记 <code>tt_</code> 赋值为 <code>LUA_TNUMINT</code>，其他和我们所料不差。我们也需要谨记，当需要改变 <code>Lua</code> 值类型时，必须同时改变它的 <code>tt_</code> 类型标记。</p>
<h4 id="luat_trybintm">luaT_trybinTM<a class="headerlink" href="#luat_trybintm" title="Permanent link">¶</a></h4>
<p>如果 <code>switch</code> 中的运算失败，继而跳出 <code>switch</code>，那么就需要执行 <code>luaT_trybinTM</code> ：</p>
<pre class="codehilite"><code class="language-c linenums">/* could not perform raw operation; try metamethod */
luaT_trybinTM(L, p1, p2, res, cast(TMS, (op - LUA_OPADD) + TM_ADD));
</code></pre>

<p>我们看注释说明：<strong>如果无法执行原始的运算，则进行元方法运算。</strong>
由于元方法涉及运算符的重载，这部分属于 <code>Lua</code> 元方法的内容，我们先标记一下，暂且跳过，等接触到元方法之后，回过头再来看这部分内容。</p>
<h4 id="_3">回到最初<a class="headerlink" href="#_3" title="Permanent link">¶</a></h4>
<pre class="codehilite"><code class="language-c linenums">// ...
luaO_arith(L, op, L-&gt;top - 2, L-&gt;top - 1, L-&gt;top - 2);
L-&gt;top--;  /* remove second operand */
lua_unlock(L);
</code></pre>

<p>当运算完成后，我们看到栈进行了一次自减操作，目的是移除位于栈中 <code>L-&gt;top - 1</code> 处的第二操作数，这个时候栈中 <code>L-&gt;top - 2</code> 索引处存储的则是运算结果了。</p>
<h4 id="_4">小结<a class="headerlink" href="#_4" title="Permanent link">¶</a></h4>
<ul>
<li><code>TValue *</code> 定义的结构体是 <code>Lua</code> 的原始值；</li>
<li>原始值中携带两份数据，一个是 <code>Value</code> 联合体定义的 <code>value_</code>，它是携带真实值的正体；一个是类型标记 <code>tt_</code>；</li>
<li><code>value_</code> 包含了所有 <code>Lua</code> 值类型的数据，分别是：<code>可回收的对象 : gc</code>、<code>轻量级 userdata : p</code>、<code>布尔值 : b</code>、<code>轻量级 C 函数 : f</code>、<code>整型数 : i</code> 和 <code>浮点数 : n</code>；</li>
<li>当原始值数据变化时，类型标记 <code>tt_</code> 也将对应改变，如: <code>(o)-&gt;i=n_x</code>，则对应地 <code>(o)-&gt;tt_=LUA_TNUMINT</code>。</li>
</ul>
<h3 id="_5">终了<a class="headerlink" href="#_5" title="Permanent link">¶</a></h3>
<ol>
<li>看一次源码，复习好多 C 知识，虽然很累，但很充实。</li>
<li>栈的数据结构可以去复习一下。</li>
<li>阅读中发现了很多 Lua 内置实现的彩蛋，有一种探险的惊喜。</li>
</ol>
<h3 id="_6">参考<a class="headerlink" href="#_6" title="Permanent link">¶</a></h3>
<ul>
<li><a href="https://zh.wikipedia.org/wiki/%E5%A0%86%E6%A0%88">堆栈 Wikipedia</a></li>
<li><a href="http://www.cppblog.com/cxiaojia/archive/2012/08/01/185913.html">基本数据结构：栈（stack）</a></li>
</ul></div></div>
        
        
    </div>

    
      <footer class="col-md-12 text-center">
          
          
            <hr>
            <p>
            <small>Copyright &copy; 2021 DoooReyn <a href="http://beian.miit.gov.cn" target="_blank">闽ICP备19014786号-1</a></small><br>
            
            <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</small>
            </p>
          

          
          
      </footer>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../../../js/bootstrap-3.0.3.min.js"></script>

    
    <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/highlight.min.js"></script>
        
                <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/languages/bat.min.js"></script>
                <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/languages/c.min.js"></script>
                <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/languages/cpp.min.js"></script>
                <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/languages/javascript.min.js"></script>
                <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/languages/lua.min.js"></script>
                <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/languages/php.min.js"></script>
                <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/languages/python.min.js"></script>
                <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/languages/shell.min.js"></script>
                <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/languages/typescript.min.js"></script>
                <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.0/build/languages/yaml.min.js"></script>
        
    <script>hljs.initHighlightingOnLoad();</script>
    

    <script>var base_url = "../../.."</script>
    
    <script src="../../../js/base.js"></script>

    <div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    </body>

</html>
